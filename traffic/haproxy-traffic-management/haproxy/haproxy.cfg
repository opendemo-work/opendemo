global
    log stdout format raw daemon info
    maxconn 4096
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-keep-alive 1000ms
    timeout check 5000ms
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# 前端配置
frontend http_front
    bind *:80
    mode http
    
    # 请求捕获用于日志
    capture request header Host len 32
    capture request header User-Agent len 64
    capture request header X-Forwarded-For len 15
    
    # ACL规则定义
    acl is_api path_beg /api/
    acl is_web path_beg /web/
    acl is_health path /health
    acl is_static path_end .css .js .png .jpg .ico
    acl is_mobile hdr_sub(User-Agent) -i mobile
    acl is_chrome hdr_sub(User-Agent) -i chrome
    
    # 基于路径的路由
    use_backend api_servers if is_api
    use_backend web_servers if is_web
    use_backend static_backend if is_static
    use_backend mobile_backend if is_mobile
    
    # 默认后端
    default_backend web_servers

# HTTPS前端
frontend https_front
    bind *:443 ssl crt /usr/local/etc/haproxy/ssl/default.pem
    mode http
    
    # 强制HTTPS重定向
    redirect scheme https code 301 if !{ ssl_fc }
    
    # HSTS头部
    rspadd Strict-Transport-Security:\ max-age=31536000;\ includeSubDomains;\ preload
    
    # 复用HTTP前端的ACL规则
    acl is_api path_beg /api/
    acl is_web path_beg /web/
    acl is_health path /health
    acl is_static path_end .css .js .png .jpg .ico
    
    use_backend api_servers if is_api
    use_backend web_servers if is_web
    use_backend static_backend if is_static
    default_backend web_servers

# 后端服务器配置

# API服务器集群 - 轮询负载均衡
backend api_servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server api1 api-server-1:3000 check inter 2000 rise 2 fall 3
    server api2 api-server-2:3000 check inter 2000 rise 2 fall 3
    
    # API特定的头部处理
    rspadd X-Backend-Server:\ api_cluster
    reqadd X-Forwarded-Proto:\ https

# Web服务器集群 - 最少连接负载均衡
backend web_servers
    balance leastconn
    option httpchk GET /health
    http-check expect status 200
    server web1 web-server-1:80 check inter 3000 rise 2 fall 3 weight 10
    server web2 web-server-2:80 check inter 3000 rise 2 fall 3 weight 20
    server web3 web-server-3:80 check inter 3000 rise 2 fall 3 weight 30
    
    # 压缩支持
    compression algo gzip
    compression type text/html text/plain text/css application/javascript

# 移动端专用后端
backend mobile_backend
    balance uri
    option httpchk GET /mobile-health
    http-check expect status 200
    server mobile1 web-server-1:80 check inter 5000 rise 2 fall 3
    server mobile2 web-server-2:80 check inter 5000 rise 2 fall 3

# 静态文件后端
backend static_backend
    balance roundrobin
    option httpchk GET /static-health
    http-check expect status 200
    server static1 web-server-1:80 check inter 5000 rise 2 fall 3
    server static2 web-server-2:80 check inter 5000 rise 2 fall 3
    
    # 静态文件优化
    http-response set-header Cache-Control "public, max-age=31536000"

# 健康检查端点
backend health_backend
    mode http
    balance roundrobin
    server local 127.0.0.1:8080 check

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats admin if LOCALHOST
    stats auth admin:haproxy123
    
    # 自定义统计
    stats realm HAProxy\ Statistics
    stats hide-version

# 速率限制配置
frontend rate_limit_front
    bind *:8080
    mode http
    
    # 全局限速 - 每个IP每分钟100个请求
    stick-table type ip size 1m expire 1m store http_req_rate(60s)
    http-request track-sc0 src
    http-request deny if { sc0_http_req_rate gt 100 }
    
    # API限速 - 每个IP每分钟50个请求
    acl is_api path_beg /api/
    stick-table type ip size 1m expire 1m store http_req_rate(60s)
    http-request track-sc1 src if is_api
    http-request deny if is_api { sc1_http_req_rate gt 50 }
    
    # 静态文件不限速
    acl is_static path_end .css .js .png .jpg .ico
    use_backend static_backend if is_static
    
    default_backend web_servers

# 维护模式
backend maintenance
    mode http
    balance roundrobin
    server maintenance 127.0.0.1:8081 check
    http-request set-header Content-Type text/html
    http-request set-body '<html><body><h1>Maintenance Mode</h1><p>System is currently under maintenance.</p></body></html>'
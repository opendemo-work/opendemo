<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAProxy è´Ÿè½½å‡è¡¡æ¼”ç¤º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .server-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .endpoint {
            background: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #45a049;
        }
        .health-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .healthy {
            background: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #3c763d;
        }
        .unhealthy {
            background: #f2dede;
            border: 1px solid #ebccd1;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ HAProxy è´Ÿè½½å‡è¡¡æ¼”ç¤º</h1>
            <p>æ¬¢è¿æ¥åˆ°é«˜å¯ç”¨Webåº”ç”¨æ¼”ç¤ºç¯å¢ƒ</p>
        </div>

        <div class="server-info">
            <h3>ğŸ–¥ï¸ æœåŠ¡å™¨ä¿¡æ¯</h3>
            <p><strong>æœåŠ¡å™¨åç§°:</strong> <span id="server-name">Loading...</span></p>
            <p><strong>æœåŠ¡å™¨IP:</strong> <span id="server-ip">Loading...</span></p>
            <p><strong>å½“å‰æ—¶é—´:</strong> <span id="current-time"></span></p>
            <p><strong>è¯·æ±‚è®¡æ•°:</strong> <span id="request-count">0</span></p>
        </div>

        <div class="endpoint">
            <h3>ğŸ”— å¯ç”¨ç«¯ç‚¹</h3>
            <a href="/health" class="button">å¥åº·æ£€æŸ¥</a>
            <a href="/api/info" class="button">APIä¿¡æ¯</a>
            <a href="/static/style.css" class="button">é™æ€èµ„æº</a>
            <a href="/mobile" class="button">ç§»åŠ¨ç«¯é¡µé¢</a>
        </div>

        <div class="endpoint">
            <h3>ğŸ“Š è´Ÿè½½æµ‹è¯•</h3>
            <button class="button" onclick="loadTest()">å‘èµ·è´Ÿè½½æµ‹è¯•</button>
            <button class="button" onclick="stressTest()">å‹åŠ›æµ‹è¯•</button>
            <div id="test-results"></div>
        </div>

        <div class="endpoint">
            <h3>ğŸ¥ å¥åº·çŠ¶æ€</h3>
            <div id="health-status" class="health-status healthy">
                âœ”ï¸ æœåŠ¡è¿è¡Œæ­£å¸¸
            </div>
        </div>

        <div class="endpoint">
            <h3>ğŸ“ˆ å®æ—¶ç»Ÿè®¡</h3>
            <div id="statistics">
                <p>è¿æ¥æ•°: <span id="connections">0</span></p>
                <p>å¤„ç†è¯·æ±‚æ•°: <span id="processed-requests">0</span></p>
                <p>å¹³å‡å“åº”æ—¶é—´: <span id="avg-response-time">0ms</span></p>
            </div>
        </div>
    </div>

    <script>
        // è·å–æœåŠ¡å™¨ä¿¡æ¯
        fetch('/api/server-info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('server-name').textContent = data.serverName;
                document.getElementById('server-ip').textContent = data.serverIp;
            })
            .catch(error => {
                console.error('Error fetching server info:', error);
                document.getElementById('server-name').textContent = 'Unknown';
                document.getElementById('server-ip').textContent = 'Unknown';
            });

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // è¯·æ±‚è®¡æ•°
        let requestCount = 0;
        function incrementRequestCount() {
            requestCount++;
            document.getElementById('request-count').textContent = requestCount;
        }
        incrementRequestCount();

        // è´Ÿè½½æµ‹è¯•
        function loadTest() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>æ­£åœ¨æ‰§è¡Œè´Ÿè½½æµ‹è¯•...</p>';
            
            const startTime = Date.now();
            let completedRequests = 0;
            const totalRequests = 10;
            
            for(let i = 0; i < totalRequests; i++) {
                fetch('/api/test-endpoint')
                    .then(() => {
                        completedRequests++;
                        if(completedRequests === totalRequests) {
                            const endTime = Date.now();
                            const duration = endTime - startTime;
                            resultsDiv.innerHTML = `
                                <p>âœ… è´Ÿè½½æµ‹è¯•å®Œæˆ!</p>
                                <p>æ€»è¯·æ±‚æ•°: ${totalRequests}</p>
                                <p>æ€»è€—æ—¶: ${duration}ms</p>
                                <p>å¹³å‡å“åº”æ—¶é—´: ${(duration/totalRequests).toFixed(2)}ms</p>
                            `;
                        }
                    })
                    .catch(error => {
                        resultsDiv.innerHTML += `<p>âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                    });
            }
        }

        // å‹åŠ›æµ‹è¯•
        function stressTest() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>æ­£åœ¨æ‰§è¡Œå‹åŠ›æµ‹è¯•...</p>';
            
            let activeRequests = 0;
            const maxConcurrent = 20;
            const testDuration = 10000; // 10ç§’
            
            const startTime = Date.now();
            const interval = setInterval(() => {
                if(Date.now() - startTime > testDuration) {
                    clearInterval(interval);
                    resultsDiv.innerHTML += '<p>ğŸ å‹åŠ›æµ‹è¯•ç»“æŸ</p>';
                    return;
                }
                
                if(activeRequests < maxConcurrent) {
                    activeRequests++;
                    fetch('/api/stress-test')
                        .then(() => {
                            activeRequests--;
                        })
                        .catch(() => {
                            activeRequests--;
                        });
                }
            }, 100);
        }

        // æ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®æ›´æ–°
        setInterval(() => {
            document.getElementById('connections').textContent = Math.floor(Math.random() * 50) + 10;
            document.getElementById('processed-requests').textContent = Math.floor(Math.random() * 1000) + 500;
            document.getElementById('avg-response-time').textContent = (Math.random() * 50 + 10).toFixed(2) + 'ms';
        }, 2000);

        // æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥
        setInterval(() => {
            const isHealthy = Math.random() > 0.1; // 90%æ¦‚ç‡å¥åº·
            const healthDiv = document.getElementById('health-status');
            if(isHealthy) {
                healthDiv.className = 'health-status healthy';
                healthDiv.innerHTML = 'âœ”ï¸ æœåŠ¡è¿è¡Œæ­£å¸¸';
            } else {
                healthDiv.className = 'health-status unhealthy';
                healthDiv.innerHTML = 'âš ï¸ æœåŠ¡å‡ºç°å¼‚å¸¸';
            }
        }, 5000);
    </script>
</body>
</html>
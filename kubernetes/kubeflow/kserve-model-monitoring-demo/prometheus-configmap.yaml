apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'kserve-metrics'
        kubernetes_sd_configs:
        - role: service
        relabel_configs:
        # 只抓取带有 metrics 注解的服务
        - source_labels: [__meta_kubernetes_service_annotation_metrics_kserve_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_service_annotation_metrics_kserve_io_port]
          target_label: __param_target
          replacement: "$1"
        - source_labels: [__meta_kubernetes_service_annotation_metrics_kserve_io_path]
          target_label: __metrics_path__
          replacement: /$1
        - source_labels: [__address__, __param_target]
          target_label: instance
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
        - action: drop
          regex: ''
          source_labels: [__param_target]
        - source_labels: [__param_target]
          target_label: __address__
          replacement: kserve-controller-metrics.kserve-system.svc.cluster.local:8080  # 控制器指标
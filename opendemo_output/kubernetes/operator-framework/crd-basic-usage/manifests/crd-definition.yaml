apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  # CRD的名称格式：<plural>.<group>
  name: appdeployments.demo.opendemo.io
spec:
  # 指定CRD所属的API组
  group: demo.opendemo.io
  
  # 支持的资源范围：Namespaced（命名空间级别）或 Cluster（集群级别）
  scope: Namespaced
  
  # 资源名称配置
  names:
    # 复数形式，用于URL: /apis/<group>/<version>/<plural>
    plural: appdeployments
    # 单数形式，用于命令行显示
    singular: appdeployment
    # Kind名称，用于YAML配置
    kind: AppDeployment
    # 简写，方便kubectl命令使用，如：kubectl get appdep
    shortNames:
    - appdep
    # 资源类别，便于分组显示
    categories:
    - all
  
  # 支持的API版本列表
  versions:
  - name: v1
    # 标记为服务版本（当前提供服务的版本）
    served: true
    # 标记为存储版本（数据持久化使用的版本）
    storage: true
    
    # Schema定义：使用OpenAPI v3规范定义资源结构
    schema:
      openAPIV3Schema:
        type: object
        properties:
          # Spec字段：期望状态定义
          spec:
            type: object
            required:
            - replicas
            - image
            - port
            properties:
              # 副本数量配置
              replicas:
                type: integer
                description: "应用副本数量"
                minimum: 1
                maximum: 10
                default: 1
              
              # 容器镜像配置
              image:
                type: string
                description: "容器镜像地址，格式如 nginx:1.21"
                pattern: '^[a-zA-Z0-9\.\-\/\:]+$'
              
              # 服务端口配置
              port:
                type: integer
                description: "应用服务端口"
                minimum: 1
                maximum: 65535
                default: 8080
              
              # 资源限制配置
              resources:
                type: object
                properties:
                  # CPU资源配置
                  cpu:
                    type: string
                    description: "CPU资源限制，如 100m, 1"
                    pattern: '^[0-9]+[m]?$'
                    default: "100m"
                  
                  # 内存资源配置
                  memory:
                    type: string
                    description: "内存资源限制，如 128Mi, 1Gi"
                    pattern: '^[0-9]+[KMG]i$'
                    default: "128Mi"
          
          # Status字段：实际状态记录
          status:
            type: object
            properties:
              # 当前阶段
              phase:
                type: string
                description: "部署阶段"
                enum:
                - Pending
                - Running
                - Failed
              
              # 准备就绪的副本数
              readyReplicas:
                type: integer
                description: "已就绪的副本数量"
                minimum: 0
              
              # 状态条件列表
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      description: "条件类型"
                    status:
                      type: string
                      description: "条件状态：True/False/Unknown"
                      enum:
                      - "True"
                      - "False"
                      - "Unknown"
                    lastTransitionTime:
                      type: string
                      format: date-time
                      description: "最后状态转换时间"
                    reason:
                      type: string
                      description: "状态原因"
                    message:
                      type: string
                      description: "状态详细信息"
              
              # 最后更新时间
              lastUpdateTime:
                type: string
                format: date-time
                description: "最后更新时间"
    
    # 自定义kubectl输出列配置
    additionalPrinterColumns:
    - name: Replicas
      type: integer
      description: "期望副本数"
      jsonPath: .spec.replicas
    - name: Ready
      type: integer
      description: "就绪副本数"
      jsonPath: .status.readyReplicas
    - name: Phase
      type: string
      description: "当前阶段"
      jsonPath: .status.phase
    - name: Image
      type: string
      description: "容器镜像"
      jsonPath: .spec.image
      priority: 1
    - name: Age
      type: date
      description: "创建时间"
      jsonPath: .metadata.creationTimestamp
    
    # 子资源配置
    subresources:
      # 启用status子资源，允许独立更新status字段
      status: {}
      # 启用scale子资源，支持kubectl scale命令
      scale:
        # 指定副本数字段路径
        specReplicasPath: .spec.replicas
        statusReplicasPath: .status.readyReplicas
